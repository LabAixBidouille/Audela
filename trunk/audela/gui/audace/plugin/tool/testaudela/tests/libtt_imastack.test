#--- je recupere le buffer de la premiere visu
set bufNo [::confVisu::getBufNo 1]

#-------------------------------------------------------------------------------
test imastack_init {prepare 3 fichiers  } {
   #--- je cree une image de niveau 100
   set naxis1 768
   set naxis2 512
   set bufTemp [::buf::create]
   buf$bufTemp setpixels CLASS_GRAY $naxis1 $naxis2 FORMAT_USHORT COMPRESS_NONE 0
   buf$bufTemp setkwd [list "NAXIS" 2 int "" ""]
   buf$bufTemp setkwd [list "NAXIS1" $naxis1 int "" ""]
   buf$bufTemp setkwd [list "NAXIS2" $naxis2 int "" ""]
   buf$bufTemp offset 50

   #--- image 1 intensite(1,1)=200
   buf$bufTemp copyto $bufNo
   buf$bufNo setpix {1 1} 100
   set exptime "60"
   set dateObs "2008-12-05T22:00:00.00"
   set dateEnd "2008-12-05T22:01:00.00"
   buf$bufNo setkwd [list "EXPOSURE"  $exptime float    "" "s"]
   buf$bufNo setkwd [list "DATE-OBS" $dateObs string "Start of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "DATE-END" $dateEnd string "End of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "NAXIS" 2 int "" ""]
   buf$bufNo setkwd [list "NAXIS1" $naxis1 int "" ""]
   buf$bufNo setkwd [list "NAXIS2" $naxis2 int "" ""]
   buf$bufNo save $::audace(rep_images)/imastack-1.fit

   #--- image 2 intensite(2,2)=200
   buf$bufTemp copyto $bufNo
   buf$bufNo setpix {2 2} 200
   set exptime "60"
   set dateObs "2008-12-05T22:01:30.00"
   set dateEnd "2008-12-05T22:02:30.00"
   buf$bufNo setkwd [list "EXPOSURE"  $exptime float    "" "s"]
   buf$bufNo setkwd [list "DATE-OBS" $dateObs string "Start of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "DATE-END" $dateEnd string "End of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "NAXIS" 2 int "" ""]
   buf$bufNo setkwd [list "NAXIS1" $naxis1 int "" ""]
   buf$bufNo setkwd [list "NAXIS2" $naxis2 int "" ""]
   buf$bufNo save $::audace(rep_images)/imastack-2.fit

   #--- image 2 intensite(2,2)=200
   buf$bufTemp copyto $bufNo
   buf$bufNo setpix {3 3} 300
   set exptime "60"
   set dateObs "2008-12-05T22:03:00.00"
   set dateEnd "2008-12-05T22:04:00.00"
   buf$bufNo setkwd [list "EXPOSURE"  $exptime float    "" "s"]
   buf$bufNo setkwd [list "DATE-OBS" $dateObs string "Start of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "DATE-END" $dateEnd string "End of exposure. FITS standard" "Iso 8601"]
   buf$bufNo setkwd [list "NAXIS" 2 int "" ""]
   buf$bufNo setkwd [list "NAXIS1" $naxis1 int "" ""]
   buf$bufNo setkwd [list "NAXIS2" $naxis2 int "" ""]
   buf$bufNo save $::audace(rep_images)/imastack-3.fit

   ::buf::delete $bufTemp

   return "1"
} "1"

#-------------------------------------------------------------------------------
test imastack_sadd2 {sadd2  } {

return 1

   #--- je teste la somme avec l'option DATE-END
   sadd imastack- add 3 1 "DATE-END"

   buf$bufNo load $::audace(rep_images)/add.fit
   confVisu::autovisu 1
   update
   file delete $::audace(rep_images)/add.fit

   set pix1 [lindex [buf$bufNo getpix {1 1}] 1]
   return [expr $pix1 == 250]
} "1"

#-------------------------------------------------------------------------------
test imastack_add {ttscript2 IMA/STACK ADD  } {


   #--- je cree une image de niveau 100
   ttscript2 "IMA/STACK \"$::audace(rep_images)\" \"imastack-1.fit imastack-2.fit imastack-3.fit\" * * \"\" \"$::audace(rep_images)\" \"add.fit\" . \"\" \"ADD\" \"DATE-END\" "

   buf$bufNo load $::audace(rep_images)/add.fit
   confVisu::autovisu 1
   update
   file delete $::audace(rep_images)/add.fit

   set pix1 [lindex [buf$bufNo getpix {1 1}] 1]
   #--- je verifie que c'est egal a la somme 100+50+50 = 200
   return [expr $pix1 == 200]

} "1"

#-------------------------------------------------------------------------------
test imastack_end {imastack ADD ajoute 3 images ttscript2 } {

   #--- je supprime le fichiers de travail
   file delete $::audace(rep_images)/imastack-1.fit
   file delete $::audace(rep_images)/imastack-2.fit
   file delete $::audace(rep_images)/imastack-3.fit

   return ""
}  ""
